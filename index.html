<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Spanish Audio with Custom Captions</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.6;
      padding: 40px 20px;
      background-color: #f4f4f8;
      color: #333;
    }

    h1 {
      font-size: 2.2em;
      text-align: center;
      margin-bottom: 40px;
      color: #2c3e50;
    }

    .phrase-block {
      margin-bottom: 50px;
    }

    h2 {
      font-size: 1.5em;
      margin-bottom: 15px;
      cursor: pointer;
      color: #007acc;
      background: #e9f4fb;
      padding: 10px 15px;
      border-radius: 8px;
      transition: background-color 0.3s;
    }

    h2:hover {
      background-color: #d3eaf8;
    }

    audio {
      display: block;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
    }

    .caption-display {
      margin-top: 10px;
      font-size: 1.1em;
      padding: 10px;
      background-color: #fff7e6;
      border-left: 5px solid #ffd966;
      width: 100%;
      max-width: 400px;
      border-radius: 4px;
    }

    mark {
      background-color: #ffeb99;
      padding: 0 4px;
      border-radius: 4px;
    }

    .content-block {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease, opacity 0.5s ease;
      opacity: 0;
    }

    .content-block.visible {
      max-height: 500px;
      opacity: 1;
    }
  </style>
</head>

<body>
  <h1>Spanish Audio with Custom Captions</h1>
  <div id="phrases-container"></div>

  <script>
    const phrases = [
      {
        id: "hola",
        text: "Hola",
        audio: "audio/Hola.mp3",
        vtt: "captions/hola.vtt"
      },
      {
        id: "como_estas",
        text: "¿Cómo estás?",
        audio: "audio/como_estas.mp3",
        vtt: "captions/como_estas.vtt"
      },
      {
        id: "buenos_dias",
        text: "Buenos días",
        audio: "audio/buenos_dias.mp3",
        vtt: "captions/buenos_dias.vtt"
      },
      {
        id: "gracias",
        text: "Gracias",
        audio: "audio/gracias.mp3",
        vtt: "captions/gracias.vtt"
      },
      {
        id: "hasta_luego",
        text: "Hasta luego",
        audio: "audio/hasta_luego.mp3",
        vtt: "captions/hasta_luego.vtt"
      }
    ];

    const container = document.getElementById("phrases-container");
    const intervals = {};

    phrases.forEach(phrase => {
      const block = document.createElement("div");
      block.className = "phrase-block";
      block.innerHTML = `
        <h2 id="heading-${phrase.id}" onclick="toggleVisibility('${phrase.id}')">${phrase.text}</h2>
        <div id="content-${phrase.id}" class="content-block">
          <audio id="audio-${phrase.id}" controls preload="metadata"></audio>
          <div class="caption-display" id="caption-${phrase.id}" aria-live="polite"></div>
        </div>
      `;
      container.appendChild(block);
      fetchAndParseVTT(phrase);

      const audio = document.getElementById(`audio-${phrase.id}`);
      const source = document.createElement("source");
      source.src = phrase.audio;
      source.type = "audio/mpeg";
      audio.appendChild(source);

      audio.addEventListener("play", () => startCaptions(phrase.id));
      audio.addEventListener("pause", () => stopCaptions(phrase.id));
      audio.addEventListener("ended", () => stopCaptions(phrase.id));
    });

    const captionsData = {};

    function toggleVisibility(id) {
      phrases.forEach(phrase => {
        const content = document.getElementById(`content-${phrase.id}`);
        if (phrase.id === id) {
          content.classList.toggle("visible");
        } else {
          content.classList.remove("visible");
        }
      });
    }

    function fetchAndParseVTT(phrase) {
      fetch(phrase.vtt)
        .then(res => res.text())
        .then(vttText => {
          const captions = [];
          const blocks = vttText.split(/\n\n+/);
          blocks.forEach(block => {
            const lines = block.trim().split('\n');
            if (lines.length >= 2) {
              const [start, end] = lines[0].split(' --> ');
              const text = lines[1];
              captions.push({
                start: parseTime(start),
                end: parseTime(end),
                text: text.trim()
              });
            }
          });
          captionsData[phrase.id] = captions;
        });
    }

    function parseTime(timeStr) {
      const [h, m, s] = timeStr.split(":");
      const [sec, ms] = s.split(".");
      return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(sec) + parseInt(ms) / 1000;
    }

    function startCaptions(id) {
      const audio = document.getElementById(`audio-${id}`);
      const captionDiv = document.getElementById(`caption-${id}`);
      const captions = captionsData[id] || [];

      intervals[id] = setInterval(() => {
        const t = audio.currentTime;
        const match = captions.find(c => t >= c.start && t <= c.end);
        captionDiv.innerHTML = match ? `<mark>${match.text}</mark>` : '';
      }, 100);
    }

    function stopCaptions(id) {
      clearInterval(intervals[id]);
    }
  </script>
</body>

</html>