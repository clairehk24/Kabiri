<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Spanish Audio with Custom Captions</title>
  <style>
    body {
      font-family: sans-serif;
      line-height: 1.5;
      padding: 20px;
      background-color: #f9f9f9;
    }

    .phrase-block {
      margin-bottom: 50px;
    }

    h2 {
      font-size: 1.4em;
      margin-bottom: 10px;
    }

    audio {
      display: block;
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
    }

    .caption-display {
      margin-top: 10px;
      font-size: 1.2em;
      padding: 10px;
      background-color: #fff3cd;
      border-left: 6px solid #ffeeba;
      width: 100%;
      max-width: 400px;
    }

    mark {
      background-color: #ffd54f;
      padding: 0 4px;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <h1>Spanish Audio with Custom Captions</h1>
  <div id="phrases-container"></div>

  <script>
    const phrases = [
      {
        id: "hola",
        text: "Hola",
        audio: "audio/hola.mp3",
        vtt: "captions/hola.vtt"
      },
      {
        id: "como_estas",
        text: "¿Cómo estás?",
        audio: "audio/como_estas.mp3",
        vtt: "captions/como_estas.vtt"
      },
      {
        id: "buenos_dias",
        text: "Buenos días",
        audio: "audio/buenos_dias.mp3",
        vtt: "captions/buenos_dias.vtt"
      },
      {
        id: "gracias",
        text: "Gracias",
        audio: "audio/gracias.mp3",
        vtt: "captions/gracias.vtt"
      },
      {
        id: "hasta_luego",
        text: "Hasta luego",
        audio: "audio/hasta_luego.mp3",
        vtt: "captions/hasta_luego.vtt"
      }
    ];

    const container = document.getElementById("phrases-container");
    const intervals = {}; // store intervals so we can manage them per audio

    phrases.forEach(phrase => {
      const block = document.createElement("div");
      block.className = "phrase-block";
      block.innerHTML = `
        <h2>${phrase.text}</h2>
        <audio id="audio-${phrase.id}" controls preload="metadata"></audio>
        <div class="caption-display" id="caption-${phrase.id}" aria-live="polite"></div>
      `;
      container.appendChild(block);
      fetchAndParseVTT(phrase);

      const audio = document.getElementById(`audio-${phrase.id}`);
      const source = document.createElement("source");
      source.src = phrase.audio;
      source.type = "audio/mpeg";
      audio.appendChild(source);

      audio.addEventListener("play", () => startCaptions(phrase.id));
      audio.addEventListener("pause", () => stopCaptions(phrase.id));
      audio.addEventListener("ended", () => stopCaptions(phrase.id));
    });

    const captionsData = {}; // Stores parsed captions for each phrase

    function fetchAndParseVTT(phrase) {
      fetch(phrase.vtt)
        .then(res => res.text())
        .then(vttText => {
          const captions = [];
          const blocks = vttText.split(/\n\n+/);
          blocks.forEach(block => {
            const lines = block.trim().split('\n');
            if (lines.length >= 2) {
              const [start, end] = lines[0].split(' --> ');
              const text = lines[1];
              captions.push({
                start: parseTime(start),
                end: parseTime(end),
                text: text.trim()
              });
            }
          });
          captionsData[phrase.id] = captions;
        });
    }

    function parseTime(timeStr) {
      const [h, m, s] = timeStr.split(":");
      const [sec, ms] = s.split(".");
      return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(sec) + parseInt(ms) / 1000;
    }

    function startCaptions(id) {
      const audio = document.getElementById(`audio-${id}`);
      const captionDiv = document.getElementById(`caption-${id}`);
      const captions = captionsData[id] || [];

      intervals[id] = setInterval(() => {
        const t = audio.currentTime;
        const match = captions.find(c => t >= c.start && t <= c.end);
        captionDiv.innerHTML = match ? `<mark>${match.text}</mark>` : '';
      }, 100);
    }

    function stopCaptions(id) {
      clearInterval(intervals[id]);
    }
  </script>
</body>

</html>